-- Social Sentry Master SQL File
-- This file contains the schema for the application as defined in DatabaseService.cs.
-- Use this to restore the database if it is deleted.

-- 1. Settings (Encryption / Config)
CREATE TABLE IF NOT EXISTS Settings (
    Key TEXT PRIMARY KEY,
    Value TEXT,
    EncryptionSalt TEXT
);

-- 2. Rules (Blocking & Limits)
CREATE TABLE IF NOT EXISTS Rules (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Type TEXT, -- 'App', 'Url', 'Title'
    Value TEXT,
    Category TEXT,
    Action TEXT, -- 'Block', 'Limit'
    LimitSeconds INTEGER,
    ScheduleJson TEXT
);

-- 3. Activity Log (Granular)
CREATE TABLE IF NOT EXISTS ActivityLog (
    LogId INTEGER PRIMARY KEY AUTOINCREMENT,
    Timestamp TEXT NOT NULL,
    ProcessName TEXT NOT NULL,
    ProcessId INTEGER,
    WindowTitle TEXT,
    Url TEXT,
    DurationSeconds INTEGER,
    Category TEXT
);

-- 4. Daily Stats (Aggregated)
CREATE TABLE IF NOT EXISTS DailyStats (
    Date TEXT,
    ProcessName TEXT,
    Category TEXT,
    TotalSeconds INTEGER,
    PRIMARY KEY (Date, ProcessName)
);

-- 5. Classification Rules (Dynamic Categorization)
CREATE TABLE IF NOT EXISTS ClassificationRules (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Pattern TEXT,
    MatchType TEXT, -- 'Contains', 'Exact', 'Regex'
    Category TEXT,
    Priority INTEGER
);


-- 6. Hourly Stats (Aggregated for Graph Performance)
CREATE TABLE IF NOT EXISTS HourlyStats (
    Date TEXT,
    Hour INTEGER,
    ProcessName TEXT,
    Category TEXT,
    TotalSeconds REAL,
    PRIMARY KEY (Date, Hour, ProcessName)
);

-- ==========================================
-- SUPABASE BACKEND SCHEMA (Social Sentry Community)
-- ==========================================

-- 1. Profiles Table (Public Profile Data)
create table public.profiles (
  id uuid references auth.users not null,
  username text unique,
  full_name text,
  avatar_url text,
  rank text,
  role text default 'member',
  email text,
  is_verified boolean default false,
  updated_at timestamp with time zone,
  
  primary key (id),
  constraint username_length check (char_length(username) >= 3)
);

alter table public.profiles enable row level security;

create policy "Public profiles are viewable by everyone."
  on profiles for select
  using ( true );

create policy "Users can insert their own profile."
  on profiles for insert
  with check ( auth.uid() = id );

create policy "Users can update own profile."
  on profiles for update
  using ( auth.uid() = id );

-- 2. Messages Table (Community Chat)
create table public.messages (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users default auth.uid(), -- Link to auth user
  content text check (char_length(content) > 0),
  username text, -- Snapshot, but ideally join with profiles
  avatar_url text, -- Snapshot
  rank text, -- Snapshot/Historic
  role text, -- Snapshot
  strike_time text, -- Snapshot
  is_pinned boolean default false,
  is_verified boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.messages enable row level security;

create policy "Everyone can read messages."
  on messages for select
  using ( true );

create policy "Authenticated users can insert messages."
  on messages for insert
  with check ( auth.role() = 'authenticated' OR auth.role() = 'anon' );

-- 3. Blocked Users Table
create table public.blocked_users (
  id bigint generated by default as identity primary key,
  blocker_id uuid references auth.users not null,
  blocked_id uuid references auth.users not null,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

alter table public.blocked_users enable row level security;

create policy "Users can see who they blocked."
  on blocked_users for select
  using ( auth.uid() = blocker_id );

create policy "Users can insert their own blocks."
  on blocked_users for insert
  with check ( auth.uid() = blocker_id );

create policy "Users can delete their own blocks."
  on blocked_users for delete
  using ( auth.uid() = blocker_id );

-- Realtime Configuration
begin;
  -- drop publication if exists supabase_realtime; -- Optional: use if resetting
  -- create publication supabase_realtime; -- Usually exists
commit;
alter publication supabase_realtime add table messages;
